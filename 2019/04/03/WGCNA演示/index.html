<!DOCTYPE HTML>
<html>

<head>
	<link rel="bookmark"  type="image/x-icon"  href="/img/logo_miccall.png"/>
	<link rel="shortcut icon" href="/img/logo_miccall.png">
	
			    <title>
    Jun
    </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/css/mic_main.css" />
    <link rel="stylesheet" href="/css/dropdownMenu.css" />
    <meta name="keywords" content="Jun-bio" />
    
    	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	 
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css" />
    </noscript>
    <style type="text/css">
        body:before {
          content: ' ';
          position: fixed;
          top: 0;
          background: url('/img/1.jpg') center 0 no-repeat;
          right: 0;
          bottom: 0;
          left: 0;
          background-size: cover; 
        }
    </style>

			    
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script async type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.scrollex.min.js"></script>
    <script src="/js/jquery.scrolly.min.js"></script>
    <script src="/js/skel.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/main.js"></script>
	
	<link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">
	<script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
</head>
    
		
<!-- Layouts -->



<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_coy.css" />
<link rel="stylesheet" href="/css/typo.css" />
<!-- 文章页 -->
<body class="is-loading">
    <!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/" class="logo">Mr Jun</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special" >
            <ul class="menu links" >
			<!-- Homepage  主页  --> 
			<li >
	            <a href="/" rel="nofollow">主页</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            <a href="#s1">分类</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="category-link" href="/categories/R/">R</a></li><li><a class="category-link" href="/categories/动漫/">动漫</a></li><li><a class="category-link" href="/categories/杂记/">杂记</a></li><li><a class="category-link" href="/categories/生物信息/">生物信息</a>
	                    </ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        
		        <!-- Pages 自定义   -->
		        
		        <li>
		            <a href="/about/" title="简历">
		                简历
		            </a>
		        </li>
		        
		        <li>
		            <a href="/movie/" title="新世纪补番计划">
		                新世纪补番计划
		            </a>
		        </li>
		        
		        <li>
		            <a href="/tag/" title="标签">
		                标签
		            </a>
		        </li>
		        


            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
                    
                    <li>
                        <a title="github" href="https://github.com/ReJun" target="_blank" rel="noopener">
                            <i class="icon fa fa-github"></i>
                        </a>
                    </li>
                    
                    <li>
                        <a title="500px" href="http://500px.com" target="_blank" rel="noopener">
                            <i class="icon fa fa-500px"></i>
                        </a>
                    </li>
                    
			</ul>
</nav>

        <div id="main" >
            <div class ="post_page_title_img" style="height: 25rem;background-image: url(https://junandhisworld.oss-cn-huhehaote.aliyuncs.com/WGCNA%E6%BC%94%E7%A4%BA.jpg);background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;" >
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;"><h2 >WGCNA演示</h2></a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
                <h1 id="Created-by-Jun-转载请注明出处：Junandhisworld-com"><a href="#Created-by-Jun-转载请注明出处：Junandhisworld-com" class="headerlink" title="Created by Jun (转载请注明出处：Junandhisworld.com)"></a>Created by Jun (转载请注明出处：Junandhisworld.com)</h1><h2 id="Contents"><a href="#Contents" class="headerlink" title="Contents"></a>Contents</h2><ul>
<li>数据来源</li>
<li>代码演示</li>
<li>讨论<h2 id="一-数据来源"><a href="#一-数据来源" class="headerlink" title="一.数据来源"></a>一.数据来源</h2></li>
</ul>
<p>为了节省时间，我直接用了官方所给的数据，分别是雄性和雌性小鼠的肝脏芯片数据</p>
<p><a href="https://labs.genetics.ucla.edu/horvath/CoexpressionNetwork/Rpackages/WGCNA/Tutorials/FemaleLiver-Data.zip" target="_blank" rel="external">Female Data</a></p>
<p><a href="https://labs.genetics.ucla.edu/horvath/CoexpressionNetwork/Rpackages/WGCNA/Tutorials/MaleLiver-Data.zip" target="_blank" rel="external">Male Data</a></p>
<h2 id="二-代码演示"><a href="#二-代码演示" class="headerlink" title="二.代码演示"></a>二.代码演示</h2><p><font face="微软雅黑" size="5">数据输入</font>  </p>
<pre class=" language-r"><code class="language-r">    library<span class="token punctuation">(</span>WGCNA<span class="token punctuation">)</span>
    femData<span class="token operator">&lt;-</span>read.csv<span class="token punctuation">(</span><span class="token string">"LiverFemale3600.csv"</span><span class="token punctuation">)</span>
    dim<span class="token punctuation">(</span>femData<span class="token punctuation">)</span>    
    names<span class="token punctuation">(</span>femData<span class="token punctuation">)</span>
    datExpr0 <span class="token operator">=</span> as.data.frame<span class="token punctuation">(</span>t<span class="token punctuation">(</span>femData<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span>c<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">##对表达矩阵进行转置</span>
    names<span class="token punctuation">(</span>datExpr0<span class="token punctuation">)</span> <span class="token operator">=</span> femData<span class="token operator">$</span>substanceBXH
    rownames<span class="token punctuation">(</span>datExpr0<span class="token punctuation">)</span> <span class="token operator">=</span> names<span class="token punctuation">(</span>femData<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span>c<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    gsg <span class="token operator">=</span> goodSamplesGenes<span class="token punctuation">(</span>datExpr0<span class="token punctuation">,</span> verbose <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">##剔除不合格的基因</span>
</code></pre>
<pre class=" language-r"><code class="language-r">    Step2 样本聚类
    sampleTree <span class="token operator">=</span> hclust<span class="token punctuation">(</span>dist<span class="token punctuation">(</span>datExpr0<span class="token punctuation">)</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">"average"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">##样本聚类，可以反映样本的重    复性，也可以看出离群样本有哪些</span>
    sizeGrWindow<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span>
    par<span class="token punctuation">(</span>cex <span class="token operator">=</span> <span class="token number">0.6</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>mar <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plot<span class="token punctuation">(</span>sampleTree<span class="token punctuation">,</span> main <span class="token operator">=</span> <span class="token string">"Sample clustering to detect outliers"</span><span class="token punctuation">,</span> sub<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> xlab<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span>     cex.lab <span class="token operator">=</span> <span class="token number">1.5</span><span class="token punctuation">,</span> 
    cex.axis <span class="token operator">=</span> <span class="token number">1.5</span><span class="token punctuation">,</span> cex.main <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>

    abline<span class="token punctuation">(</span>h <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">,</span> col <span class="token operator">=</span> <span class="token string">"red"</span><span class="token punctuation">)</span>
    clust <span class="token operator">=</span> cutreeStatic<span class="token punctuation">(</span>sampleTree<span class="token punctuation">,</span> cutHeight <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">,</span> minSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>
    table<span class="token punctuation">(</span>clust<span class="token punctuation">)</span>
    keepSamples <span class="token operator">=</span> <span class="token punctuation">(</span>clust<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
    datExpr <span class="token operator">=</span> datExpr0<span class="token punctuation">[</span>keepSamples<span class="token punctuation">,</span> <span class="token punctuation">]</span>
    nGenes <span class="token operator">=</span> ncol<span class="token punctuation">(</span>datExpr<span class="token punctuation">)</span>
    nSamples <span class="token operator">=</span> nrow<span class="token punctuation">(</span>datExpr<span class="token punctuation">)</span>
</code></pre>
<p><img src="https://junandhisworld.oss-cn-huhehaote.aliyuncs.com/Sample%20clustring.jpeg?Expires=1557210161&OSSAccessKeyId=TMP.AgEnPGKXgW126NzHirTUQ__zDu0q27yuVIbWeK0BcE9TKyGLPYfHdJWVdVyqADAtAhQijE10icTlvv-sxgcsoxMZuh9cEgIVAJ02NnXt1HHvIJua7FyJSP9QC_XM&Signature=49bQ5AMWYig7OtqbDovaQ%2FKjoUA%3D"></p>
<pre class=" language-r"><code class="language-r">    Step3 阈值计算
    powers <span class="token operator">=</span> c<span class="token punctuation">(</span>c<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seq<span class="token punctuation">(</span>from <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">,</span> to<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> by<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">##计算软阈值</span>
    sft <span class="token operator">=</span> pickSoftThreshold<span class="token punctuation">(</span>datExpr<span class="token punctuation">,</span> powerVector <span class="token operator">=</span> powers<span class="token punctuation">,</span> verbose <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">##sft返回的是一个列表</span>
    sizeGrWindow<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
    par<span class="token punctuation">(</span>mfrow <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    cex1 <span class="token operator">=</span> <span class="token number">0.9</span>
    plot<span class="token punctuation">(</span>sft<span class="token operator">$</span>fitIndices<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span>sign<span class="token punctuation">(</span>sft<span class="token operator">$</span>fitIndices<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>sft<span class="token operator">$</span>fitIndices<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    xlab<span class="token operator">=</span><span class="token string">"Soft Threshold (power)"</span><span class="token punctuation">,</span>ylab<span class="token operator">=</span><span class="token string">"Scale Free Topology Model Fit,signed R^2"</span><span class="token punctuation">,</span>type<span class="token operator">=</span><span class="token string">"n"</span><span class="token punctuation">,</span>
    main <span class="token operator">=</span> paste<span class="token punctuation">(</span><span class="token string">"Scale independence"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    text<span class="token punctuation">(</span>sft<span class="token operator">$</span>fitIndices<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span>sign<span class="token punctuation">(</span>sft<span class="token operator">$</span>fitIndices<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>sft<span class="token operator">$</span>fitIndices<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    labels<span class="token operator">=</span>powers<span class="token punctuation">,</span>cex<span class="token operator">=</span>cex1<span class="token punctuation">,</span>col<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">)</span>
    abline<span class="token punctuation">(</span>h<span class="token operator">=</span><span class="token number">0.90</span><span class="token punctuation">,</span>col<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">)</span>
    plot<span class="token punctuation">(</span>sft<span class="token operator">$</span>fitIndices<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sft<span class="token operator">$</span>fitIndices<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    xlab<span class="token operator">=</span><span class="token string">"Soft Threshold (power)"</span><span class="token punctuation">,</span>ylab<span class="token operator">=</span><span class="token string">"Mean Connectivity"</span><span class="token punctuation">,</span> type<span class="token operator">=</span><span class="token string">"n"</span><span class="token punctuation">,</span>
    main <span class="token operator">=</span> paste<span class="token punctuation">(</span><span class="token string">"Mean connectivity"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    text<span class="token punctuation">(</span>sft<span class="token operator">$</span>fitIndices<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sft<span class="token operator">$</span>fitIndices<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> labels<span class="token operator">=</span>powers<span class="token punctuation">,</span> cex<span class="token operator">=</span>cex1<span class="token punctuation">,</span>col<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://junandhisworld.oss-cn-huhehaote.aliyuncs.com/Power%20soft.jpeg"></p>
<p>经过上面代码的运行，得出了软阈值的结果。从左图中可以看到，当阈值达到6时，整个网络就已经靠近无尺度网络的分布了，R方也达到了0.95左右的水平。sft这个列表当中的powerEstimate代表的便是最佳阈值。右图代表的是整个网络中，随着阈值的变化，整个网络中节点(Gene)间的连接度均值，符合幂率分布。</p>
<pre class=" language-r"><code class="language-r">    Step4 网络构建
    net <span class="token operator">=</span> blockwiseModules<span class="token punctuation">(</span>datExpr<span class="token punctuation">,</span> power <span class="token operator">=</span> sft<span class="token operator">$</span>powerEstimate<span class="token punctuation">,</span>
                       TOMType <span class="token operator">=</span> <span class="token string">"unsigned"</span><span class="token punctuation">,</span> minModuleSize <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span>
                       reassignThreshold <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> mergeCutHeight <span class="token operator">=</span> <span class="token number">0.25</span><span class="token punctuation">,</span>
                       numericLabels <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span> pamRespectsDendro <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">,</span>
                       saveTOMs <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
                       saveTOMFileBase <span class="token operator">=</span> <span class="token string">"femaleMouseTOM"</span><span class="token punctuation">,</span> verbose <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">##一步法构建网络</span>
</code></pre>
<pre class=" language-r"><code class="language-r">    Step5 模块上色
    sizeGrWindow<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>
    mergedColors <span class="token operator">=</span> labels2colors<span class="token punctuation">(</span>net<span class="token operator">$</span>colors<span class="token punctuation">)</span>
    plotDendroAndColors<span class="token punctuation">(</span>net<span class="token operator">$</span>dendrograms<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mergedColors<span class="token punctuation">[</span>net<span class="token operator">$</span>blockGenes<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"Module colors"</span><span class="token punctuation">,</span>
                    dendroLabels <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">,</span> hang <span class="token operator">=</span> <span class="token number">0.03</span><span class="token punctuation">,</span>
                    addGuide <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span> guideHang <span class="token operator">=</span> <span class="token number">0.05</span><span class="token punctuation">)</span>
    moduleLabels <span class="token operator">=</span> net<span class="token operator">$</span>colors
    moduleColors <span class="token operator">=</span> labels2colors<span class="token punctuation">(</span>net<span class="token operator">$</span>colors<span class="token punctuation">)</span><span class="token comment" spellcheck="true">##模块上色</span>
    <span class="token operator">=</span> net<span class="token operator">$</span>MEs<span class="token punctuation">;</span>
    geneTree <span class="token operator">=</span> net<span class="token operator">$</span>dendrograms<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    table<span class="token punctuation">(</span>moduleColors<span class="token punctuation">)</span><span class="token comment" spellcheck="true">##查看模块对应的颜色及模块内的基因</span>

    moduleColors
       black         blue        brown         cyan        green  greenyellow         grey       grey60 
         <span class="token number">208</span>          <span class="token number">456</span>          <span class="token number">415</span>           <span class="token number">79</span>          <span class="token number">314</span>          <span class="token number">102</span>           <span class="token number">99</span>           <span class="token number">47</span> 
   lightcyan   lightgreen      magenta midnightblue         pink       purple          red       salmon 
          <span class="token number">47</span>           <span class="token number">34</span>          <span class="token number">123</span>           <span class="token number">79</span>          <span class="token number">149</span>          <span class="token number">123</span>          <span class="token number">212</span>           <span class="token number">94</span> 
         tan    turquoise       yellow 
         <span class="token number">100</span>          <span class="token number">595</span>          <span class="token number">324</span>
</code></pre>
<p><img src="https://junandhisworld.oss-cn-huhehaote.aliyuncs.com/Cluster%20Dendgrogram.jpeg"></p>
<p>在众多模块当中，grey模块里的基因代表无法被归类到任何一个模块里的基因。同时，WGCNA也可以将距离较近的模块合并.</p>
<pre class=" language-r"><code class="language-r">     Step6 联系表型信息
    traitData <span class="token operator">=</span> read.csv<span class="token punctuation">(</span><span class="token string">"ClinicalTraits.csv"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">##引入表型信息相关数据</span>
    dim<span class="token punctuation">(</span>traitData<span class="token punctuation">)</span>
    names<span class="token punctuation">(</span>traitData<span class="token punctuation">)</span>
    allTraits <span class="token operator">=</span> traitData<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span>c<span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">##选取部分信息</span>
    allTraits <span class="token operator">=</span> allTraits<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token punctuation">]</span>
    dim<span class="token punctuation">(</span>allTraits<span class="token punctuation">)</span>
    names<span class="token punctuation">(</span>allTraits<span class="token punctuation">)</span>

    femaleSamples <span class="token operator">=</span> rownames<span class="token punctuation">(</span>datExpr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    traitRows <span class="token operator">=</span> match<span class="token punctuation">(</span>femaleSamples<span class="token punctuation">,</span> allTraits<span class="token operator">$</span>Mice<span class="token punctuation">)</span>
    datTraits <span class="token operator">=</span> allTraits<span class="token punctuation">[</span>traitRows<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    rownames<span class="token punctuation">(</span>datTraits<span class="token punctuation">)</span> <span class="token operator">=</span> allTraits<span class="token punctuation">[</span>traitRows<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>

    collectGarbage<span class="token punctuation">(</span><span class="token punctuation">)</span>

    nGenes <span class="token operator">=</span> ncol<span class="token punctuation">(</span>datExpr<span class="token punctuation">)</span>
    nSamples <span class="token operator">=</span> nrow<span class="token punctuation">(</span>datExpr<span class="token punctuation">)</span>
    MEs0 <span class="token operator">=</span> moduleEigengenes<span class="token punctuation">(</span>datExpr<span class="token punctuation">,</span> moduleColors<span class="token punctuation">)</span><span class="token operator">$</span>eigengenes
    MEs <span class="token operator">=</span> orderMEs<span class="token punctuation">(</span>MEs0<span class="token punctuation">)</span>
    moduleTraitCor <span class="token operator">=</span> cor<span class="token punctuation">(</span>MEs<span class="token punctuation">,</span> datTraits<span class="token punctuation">,</span> use <span class="token operator">=</span> <span class="token string">"p"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#计算模块和表型信息的相关系数</span>
    moduleTraitPvalue <span class="token operator">=</span> corPvalueStudent<span class="token punctuation">(</span>moduleTraitCor<span class="token punctuation">,</span> nSamples<span class="token punctuation">)</span>

    sizeGrWindow<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span>
    textMatrix <span class="token operator">=</span>  paste<span class="token punctuation">(</span>signif<span class="token punctuation">(</span>moduleTraitCor<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"\n("</span><span class="token punctuation">,</span>
                  signif<span class="token punctuation">(</span>moduleTraitPvalue<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">")"</span><span class="token punctuation">,</span> sep <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>textMatrix<span class="token punctuation">)</span> <span class="token operator">=</span> dim<span class="token punctuation">(</span>moduleTraitCor<span class="token punctuation">)</span>
    par<span class="token punctuation">(</span>mar <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8.5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#绘制表型和模块的相关性热图</span>
    labeledHeatmap<span class="token punctuation">(</span>Matrix <span class="token operator">=</span> moduleTraitCor<span class="token punctuation">,</span>
               xLabels <span class="token operator">=</span> names<span class="token punctuation">(</span>datTraits<span class="token punctuation">)</span><span class="token punctuation">,</span>
               yLabels <span class="token operator">=</span> names<span class="token punctuation">(</span>MEs<span class="token punctuation">)</span><span class="token punctuation">,</span>
               ySymbols <span class="token operator">=</span> names<span class="token punctuation">(</span>MEs<span class="token punctuation">)</span><span class="token punctuation">,</span>
               colorLabels <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">,</span>
               colors <span class="token operator">=</span> greenWhiteRed<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               textMatrix <span class="token operator">=</span> textMatrix<span class="token punctuation">,</span>
               setStdMargins <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">,</span>
               cex.text <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
               zlim <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               main <span class="token operator">=</span> paste<span class="token punctuation">(</span><span class="token string">"Module-trait relationships"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://junandhisworld.oss-cn-huhehaote.aliyuncs.com/Rplot.jpeg"></p>
<p>通过模块与表型相关性热图中可以看到：brown、red模块与weight有较高的相关性。研究者可以根据上述信息研究与目标表型相关联的模块，也可以研究感兴趣的模块。</p>
<p>比较值得注意的是，即使算出了模块与表型的相关性，一个模块里也往往存在着比较多的基因。那么具体哪些基因值得我们去做后续的分析，还需要对模块进行更深一步的细化研究。</p>
<pre class=" language-r"><code class="language-r">    Step7 GSvsMM
    weight <span class="token operator">=</span> as.data.frame<span class="token punctuation">(</span>datTraits<span class="token operator">$</span>weight_g<span class="token punctuation">)</span>
    names<span class="token punctuation">(</span>weight<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"weight"</span>
    modNames <span class="token operator">=</span> substring<span class="token punctuation">(</span>names<span class="token punctuation">(</span>MEs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    geneModuleMembership <span class="token operator">=</span> as.data.frame<span class="token punctuation">(</span>cor<span class="token punctuation">(</span>datExpr<span class="token punctuation">,</span> MEs<span class="token punctuation">,</span> use <span class="token operator">=</span> <span class="token string">"p"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">##计算模块MM值与基因间的相关系数，datExpr为表达量</span>
    MMPvalue <span class="token operator">=</span> as.data.frame<span class="token punctuation">(</span>corPvalueStudent<span class="token punctuation">(</span>as.matrix<span class="token punctuation">(</span>geneModuleMembership<span class="token punctuation">)</span><span class="token punctuation">,</span> nSamples<span class="token punctuation">)</span><span class="token punctuation">)</span>

    names<span class="token punctuation">(</span>geneModuleMembership<span class="token punctuation">)</span> <span class="token operator">=</span> paste<span class="token punctuation">(</span><span class="token string">"MM"</span><span class="token punctuation">,</span> modNames<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span>
    names<span class="token punctuation">(</span>MMPvalue<span class="token punctuation">)</span> <span class="token operator">=</span> paste<span class="token punctuation">(</span><span class="token string">"p.MM"</span><span class="token punctuation">,</span> modNames<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span>

    geneTraitSignificance <span class="token operator">=</span> as.data.frame<span class="token punctuation">(</span>cor<span class="token punctuation">(</span>datExpr<span class="token punctuation">,</span> weight<span class="token punctuation">,</span> use <span class="token operator">=</span> <span class="token string">"p"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">##计算表型weight与基因间的相关系数</span>
    GSPvalue <span class="token operator">=</span> as.data.frame<span class="token punctuation">(</span>corPvalueStudent<span class="token punctuation">(</span>as.matrix<span class="token punctuation">(</span>geneTraitSignificance<span class="token punctuation">)</span><span class="token punctuation">,</span> nSamples<span class="token punctuation">)</span><span class="token punctuation">)</span>

    names<span class="token punctuation">(</span>geneTraitSignificance<span class="token punctuation">)</span> <span class="token operator">=</span> paste<span class="token punctuation">(</span><span class="token string">"GS."</span><span class="token punctuation">,</span> names<span class="token punctuation">(</span>weight<span class="token punctuation">)</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span>
    names<span class="token punctuation">(</span>GSPvalue<span class="token punctuation">)</span> <span class="token operator">=</span> paste<span class="token punctuation">(</span><span class="token string">"p.GS."</span><span class="token punctuation">,</span> names<span class="token punctuation">(</span>weight<span class="token punctuation">)</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span>
</code></pre>
<p>在WGCNA中，定义了GS值和MM值。那么上面的代码可以简单的理解为：分别计算，ME值与基因间的相关系数，以及计算基因和表型间的相关系数。通过计算，那些不仅与模块高度相关的而且与表型也高度相关的基因就非常值得研究了。与模块高度相关的基因，往往也在这个模块中具有重要的地位或者说具有中心要素。</p>
<pre class=" language-r"><code class="language-r">     module <span class="token operator">=</span> <span class="token string">"brown"</span>
    column <span class="token operator">=</span> match<span class="token punctuation">(</span>module<span class="token punctuation">,</span> modNames<span class="token punctuation">)</span>
    moduleGenes <span class="token operator">=</span> moduleColors<span class="token operator">==</span>module

    sizeGrWindow<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    par<span class="token punctuation">(</span>mfrow <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    verboseScatterplot<span class="token punctuation">(</span>abs<span class="token punctuation">(</span>geneModuleMembership<span class="token punctuation">[</span>moduleGenes<span class="token punctuation">,</span> column<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   abs<span class="token punctuation">(</span>geneTraitSignificance<span class="token punctuation">[</span>moduleGenes<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   xlab <span class="token operator">=</span> paste<span class="token punctuation">(</span><span class="token string">"Module Membership in"</span><span class="token punctuation">,</span> module<span class="token punctuation">,</span> <span class="token string">"module"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   ylab <span class="token operator">=</span> <span class="token string">"Gene significance for body weight"</span><span class="token punctuation">,</span>
                   main <span class="token operator">=</span> paste<span class="token punctuation">(</span><span class="token string">"Module membership vs. gene significance\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   cex.main <span class="token operator">=</span> <span class="token number">1.2</span><span class="token punctuation">,</span> cex.lab <span class="token operator">=</span> <span class="token number">1.2</span><span class="token punctuation">,</span> cex.axis <span class="token operator">=</span> <span class="token number">1.2</span><span class="token punctuation">,</span> col <span class="token operator">=</span> module<span class="token punctuation">)</span>
</code></pre>
<p><img src="https://junandhisworld.oss-cn-huhehaote.aliyuncs.com/Rplot01.jpeg"></p>
<pre class=" language-r"><code class="language-r">    Step8 导出指定模块基因名
    module <span class="token operator">=</span> <span class="token string">"brown"</span>
    probes <span class="token operator">=</span> names<span class="token punctuation">(</span>datExpr<span class="token punctuation">)</span>
    inModule <span class="token operator">=</span> <span class="token punctuation">(</span>moduleColors<span class="token operator">==</span>module<span class="token punctuation">)</span>
    modProbes <span class="token operator">=</span> probes<span class="token punctuation">[</span>inModule<span class="token punctuation">]</span>
    table<span class="token punctuation">(</span>modProbes<span class="token punctuation">)</span>
</code></pre>
<pre class=" language-r"><code class="language-r">    Step9 导出模块网络
    TOM <span class="token operator">=</span> TOMsimilarityFromExpr<span class="token punctuation">(</span>datExpr<span class="token punctuation">,</span> power <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#这一步非常消耗内存</span>
    module <span class="token operator">=</span> <span class="token string">"brown"</span>
    probes <span class="token operator">=</span> names<span class="token punctuation">(</span>datExpr<span class="token punctuation">)</span>
    inModule <span class="token operator">=</span> <span class="token punctuation">(</span>moduleColors<span class="token operator">==</span>module<span class="token punctuation">)</span>
    modProbes <span class="token operator">=</span> probes<span class="token punctuation">[</span>inModule<span class="token punctuation">]</span>
    modTOM <span class="token operator">=</span> TOM<span class="token punctuation">[</span>inModule<span class="token punctuation">,</span> inModule<span class="token punctuation">]</span>
    dimnames<span class="token punctuation">(</span>modTOM<span class="token punctuation">)</span> <span class="token operator">=</span> list<span class="token punctuation">(</span>modProbes<span class="token punctuation">,</span> modProbes<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#visant格式导出</span>
    vis <span class="token operator">=</span> exportNetworkToVisANT<span class="token punctuation">(</span>modTOM<span class="token punctuation">,</span>
      file <span class="token operator">=</span> paste<span class="token punctuation">(</span><span class="token string">"VisANTInput-"</span><span class="token punctuation">,</span> module<span class="token punctuation">,</span> <span class="token string">".txt"</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      weighted <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
      threshold <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
     probeToGene <span class="token operator">=</span> data.frame<span class="token punctuation">(</span>annot<span class="token operator">$</span>substanceBXH<span class="token punctuation">,</span> annot<span class="token operator">$</span>gene_symbol<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#Cytoscape格式导出</span>
    cyt <span class="token operator">=</span> exportNetworkToCytoscape<span class="token punctuation">(</span>modTOM<span class="token punctuation">,</span>
      edgeFile <span class="token operator">=</span> paste<span class="token punctuation">(</span><span class="token string">"CytoscapeInput-edges-"</span><span class="token punctuation">,</span> paste<span class="token punctuation">(</span>modules<span class="token punctuation">,</span> collapse<span class="token operator">=</span><span class="token string">"-"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">".txt"</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      nodeFile <span class="token operator">=</span> paste<span class="token punctuation">(</span><span class="token string">"CytoscapeInput-nodes-"</span><span class="token punctuation">,</span> paste<span class="token punctuation">(</span>modules<span class="token punctuation">,</span> collapse<span class="token operator">=</span><span class="token string">"-"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">".txt"</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      weighted <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
      threshold <span class="token operator">=</span> <span class="token number">0.02</span><span class="token punctuation">,</span>
      nodeNames <span class="token operator">=</span> modProbes<span class="token punctuation">,</span>
      altNodeNames <span class="token operator">=</span> modGenes<span class="token punctuation">,</span>
      nodeAttr <span class="token operator">=</span> moduleColors<span class="token punctuation">[</span>inModule<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">#按top值筛选，选择性导出模块基因。</span>
    nTop <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
    IMConn <span class="token operator">=</span> softConnectivity<span class="token punctuation">(</span>datExpr<span class="token punctuation">[</span><span class="token punctuation">,</span> modProbes<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    top <span class="token operator">=</span> <span class="token punctuation">(</span>rank<span class="token punctuation">(</span><span class="token operator">-</span>IMConn<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> nTop<span class="token punctuation">)</span>
</code></pre>
<p>上述便是用官方的雌性小鼠肝脏的芯片数据做的一个演示。其中数据包括了表达量数据、注释信息、表型数据。这里我不再用雄性小鼠的数据做演示，方法步骤一样，只是需要对代码做一些细微的修改。</p>
<h1 id="三-讨论"><a href="#三-讨论" class="headerlink" title="三.讨论"></a>三.讨论</h1><p>关于WGCNA其实还是有很多问题的，比如：</p>
<p>批次效应的影响<br>计算阈值后，R方很小网络达不到无尺度分布<br>标准化处理的方式log2、log2(FPKM+1)、其它标准化的影响<br>关于这些问题我会在最后一章的内容中谈到，那么基本上WGCNA系列也就完结了。</p>
<p>2018/6/23 Jun</p>

            </div>

            <!-- Post Comments -->
            
    <!-- 使用 valine -->
<div id="comment">
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
<script>
    new Valine({
        el: '#comment' ,
        notify: true,
        verify: false,
        app_id: 'your appId',
        app_key: 'your appkey',
        placeholder: 'Please leave your footprints',
        pageSize: '10',
        avatar: '',
        avatar_cdn: 'https://gravatar.loli.net/avatar/'
    });
</script>
</div>
<style>
   #comment{
        padding: 2pc;
    }
</style>


        </div>
        <!-- Copyright 版权 start -->
                <div id="copyright">
            <ul>
                <li>&copy;Powered By <a href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li>
                <li>Design: <a href="http://miccall.tech " style="border-bottom: none;">miccall</a></li>
            </ul>
            
            	<span id="busuanzi_container_site_pv">2019总访问量<span id="busuanzi_value_site_pv"></span>次</span>
			
        </div>
    </div>
</body>



 	
</html>
